import "tfplan/v2" as tfplan
import "strings"

# =========================
# CONFIG (edit as needed)
# =========================

allowed_service_principals = {
  "events.amazonaws.com": true,
  "sns.amazonaws.com": true,
  "s3.amazonaws.com": true,
  "logs.amazonaws.com": true,
  "apigateway.amazonaws.com": true,
  "cloudwatch.amazonaws.com": true,
  "states.amazonaws.com": true,
}

# Optional external account allowlist (keep empty if not used)
allowed_external_accounts = {
  # "123456789012": true,
}

# =========================
# Helpers
# =========================

func lower(v) { return strings.lower(v) }

func is_allowed_service(p) {
  return allowed_service_principals[lower(p)] else false
}

func is_iam_arn(p) {
  return strings.has_prefix(p, "arn:aws:iam::")
}

# arn:aws:iam::123456789012:role/RoleName
func extract_account_id_from_arn(arn) {
  parts = strings.split(arn, ":")
  if length(parts) < 6 { return "" }
  return parts[4]
}

# =========================
# Policy logic
# =========================

violations = []

perms = tfplan.resource_changes["aws_lambda_permission"] else {}

# NOTE: using single-variable loop for maximum compatibility
for perms as addr {
  rc = perms[addr]

  after = rc.change.after else null
  if after is null { continue }

  principal = after.principal else ""
  if principal == "" { continue }

  # 1) Wildcard is always denied
  if principal == "*" {
    violations = append(violations, addr + " uses wildcard principal (*)")
    continue
  }

  # 2) Service principals: allow only from allowlist
  if strings.contains(principal, ".amazonaws.com") {
    if !is_allowed_service(principal) {
      violations = append(violations, addr + " uses unapproved service principal: " + principal)
    }
    continue
  }

  # 3) IAM principals (ARNs): deny unless allowlisted
  if is_iam_arn(principal) {
    acct = extract_account_id_from_arn(principal)
    if acct != "" and (allowed_external_accounts[acct] else false) {
      continue
    }
    violations = append(violations, addr + " allows IAM principal ARN (potential cross-account): " + principal)
    continue
  }

  # 4) Unknown principal formats: deny
  violations = append(violations, addr + " uses unsupported/unknown principal format: " + principal)
}

main = rule { length(violations) is 0 }
