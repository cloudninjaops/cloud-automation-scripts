import "tfplan/v2" as tfplan
import "types"
import "strings"

func is_null(v) { return types.type_of(v) is "null" }
func is_string(v) { return types.type_of(v) is "string" }
func is_map(v) { return types.type_of(v) is "map" }

func mget(m, k) {
  if !is_map(m) { return null }
  if m contains k { return m[k] }
  return null
}

func up(v) {
  if is_string(v) { return strings.upper(v) }
  return ""
}

urls = tfplan.resource_changes["aws_lambda_function_url"] else {}

violations = []

for urls as addr, rc {
  after = rc.change.after else null
  if is_null(after) { continue }

  auth_type = up(mget(after, "authorization_type"))
  if auth_type == "NONE" {
    violations = append(violations, {
      "resource": addr,
      "reason": "Lambda Function URL must not be unauthenticated (authorization_type='NONE'). Use AWS_IAM.",
    })
  }
}

main = rule {
  length(violations) is 0
}
