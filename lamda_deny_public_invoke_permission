import "tfplan/v2" as tfplan
import "types"
import "strings"

func is_null(v) { return types.type_of(v) is "null" }
func is_string(v) { return types.type_of(v) is "string" }
func is_map(v) { return types.type_of(v) is "map" }

func mget(m, k) {
  if !is_map(m) { return null }
  if m contains k { return m[k] }
  return null
}

func low(v) {
  if is_string(v) { return strings.lower(v) }
  return ""
}

perms = tfplan.resource_changes["aws_lambda_permission"] else {}

violations = []

for perms as addr, rc {
  after = rc.change.after else null
  if is_null(after) { continue }

  principal = mget(after, "principal")
  # Some modules use "principal = *" exactly; treat only that as public.
  if is_string(principal) and strings.trim_space(principal) == "*" {
    violations = append(violations, {
      "resource": addr,
      "reason": "Public Lambda invoke permission detected (principal='*').",
    })
  }
}

main = rule {
  length(violations) is 0
}
